<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Certificate Preview</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1>Certificate Preview</h1>
      <p class="sub">Enter <b>Certificate ID</b> → Preview + Shareable Link</p>
    </header>

    <section class="card">
      <div class="row">
        <input id="cid" placeholder="AIK256Q1A4412" autocomplete="off" />
        <button id="btn">Preview</button>
      </div>

      <div id="msg" class="msg"></div>

      <div id="shareWrap" class="share" style="display:none;">
        <div class="shareRow">
          <span class="label">Share link:</span>
          <a id="shareLink" href="#" target="_blank" rel="noopener noreferrer"></a>
          <button id="copyBtn" class="copy">Copy</button>
        </div>
      </div>

      <div class="previewWrap">
        <img id="preview" alt="Certificate Preview" />
      </div>
    </section>

    <footer class="footer">
      Powered by Vercel + Supabase Storage
    </footer>
  </div>

  <script>
    const input = document.getElementById("cid");
    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");
    const img = document.getElementById("preview");

    const shareWrap = document.getElementById("shareWrap");
    const shareLink = document.getElementById("shareLink");
    const copyBtn = document.getElementById("copyBtn");

    function setMsg(text, type="info") {
      msg.className = "msg " + type;
      msg.textContent = text || "";
    }

    function buildShareUrl(id) {
      const u = new URL(window.location.href);
      u.searchParams.set("id", id);
      return u.toString();
    }

    async function previewById(id) {
      setMsg("Loading preview…", "info");
      shareWrap.style.display = "none";
      img.removeAttribute("src");
      img.style.display = "none";

      try {
        const res = await fetch(`/api?id=${encodeURIComponent(id)}`);
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.error || "API error");
        }

        const imageUrl = data.image_url;

        const sUrl = buildShareUrl(id);
        shareLink.textContent = sUrl;
        shareLink.href = sUrl;
        shareWrap.style.display = "block";

        img.onload = () => {
          img.style.display = "block";
          setMsg("Preview loaded ✅", "ok");
        };

        img.onerror = () => {
          setMsg("Image not found. Check: bucket=photos, folder=student_images, filename must be ID.jpg", "err");
          img.style.display = "none";
        };

        img.src = imageUrl;

      } catch (e) {
        setMsg(e.message || "Something went wrong", "err");
      }
    }

    btn.addEventListener("click", () => {
      const id = input.value.trim();
      if (!id) return setMsg("Please enter Certificate ID", "err");
      previewById(id);
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btn.click();
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(shareLink.href);
        setMsg("Share link copied ✅", "ok");
      } catch {
        setMsg("Copy failed. Please copy manually.", "err");
      }
    });

    // Auto-load if opened via share link ?id=...
    const params = new URLSearchParams(window.location.search);
    const idFromUrl = params.get("id");
    if (idFromUrl) {
      input.value = idFromUrl;
      previewById(idFromUrl);
    }
  </script>
</body>
</html>

